/*! androgen 27-04-2015 */
var keystone=require("keystone"),middleware=require("./middleware"),importRoutes=keystone.importer(__dirname);keystone.pre("routes",middleware.initLocals),keystone.pre("render",middleware.flashMessages);var routes={views:importRoutes("./views")};exports=module.exports=function(a){a.get("/",routes.views.blog),a.get("/home",routes.views.index),a.get("/blog/:category?",routes.views.blog),a.get("/blog/post/:post",routes.views.post),a.get("/gallery",routes.views.gallery),a.get("/archives",routes.views.archives),a.all("/contact",routes.views.contact)};var _=require("underscore");exports.initLocals=function(a,b,c){var d=b.locals;d.navLinks=[{label:"Blog",key:"blog",href:"/blog"},{label:"Home",key:"home",href:"/home"},{label:"Gallery",key:"gallery",href:"/gallery"},{label:"Contact",key:"contact",href:"/contact"},{label:"Archives",key:"archives",href:"/archives"}],d.user=a.user,c()},exports.flashMessages=function(a,b,c){var d={info:a.flash("info"),success:a.flash("success"),warning:a.flash("warning"),error:a.flash("error")};b.locals.messages=_.any(d,function(a){return a.length})?d:!1,c()},exports.requireUser=function(a,b,c){a.user?c():(a.flash("error","Please sign in to access this page."),b.redirect("/keystone/signin"))};var keystone=require("keystone"),_=require("underscore");exports=module.exports=function(a,b){var c=new keystone.View(a,b),d=b.locals;d.section="archives",d.filters={post:a.params.post},d.data={posts:[]},c.on("init",function(a){var b=keystone.list("Post").model.find().where("state","published").sort("-publishedDate").populate("author").limit("6");b.exec(function(b,c){d.data.posts=c,_.each(d.data.posts,function(a){console.log("results title",a.title)}),a(b)})}),c.render("archives")};var keystone=require("keystone"),async=require("async");exports=module.exports=function(a,b){var c=new keystone.View(a,b),d=b.locals;d.section="blog",d.filters={category:a.params.category},d.data={posts:[],categories:[]},c.on("init",function(a){keystone.list("PostCategory").model.find().sort("name").exec(function(b,c){return b||!c.length?a(b):(d.data.categories=c,void async.each(d.data.categories,function(a,b){keystone.list("Post").model.count().where("category")["in"]([a.id]).exec(function(c,d){a.postCount=d,b(c)})},function(b){a(b)}))})}),c.on("init",function(b){a.params.category?keystone.list("PostCategory").model.findOne({key:d.filters.category}).exec(function(a,c){d.data.category=c,b(a)}):b()}),c.on("init",function(b){var c=keystone.list("Post").paginate({page:a.query.page||1,perPage:10,maxPages:10}).where("state","published").sort("-publishedDate").populate("author categories");d.data.category&&c.where("categories")["in"]([d.data.category]),c.exec(function(a,c){d.data.posts=c,b(a)})}),c.render("blog")};var keystone=require("keystone"),Enquiry=keystone.list("Enquiry");exports=module.exports=function(a,b){var c=new keystone.View(a,b),d=b.locals;d.section="contact",d.enquiryTypes=Enquiry.fields.enquiryType.ops,d.formData=a.body||{},d.validationErrors={},d.enquirySubmitted=!1,c.on("post",{action:"contact"},function(b){var c=new Enquiry.model,e=c.getUpdateHandler(a);e.process(a.body,{flashErrors:!0,fields:"name, email, phone, enquiryType, message",errorMessage:"There was a problem submitting your enquiry:"},function(a){a?d.validationErrors=a.errors:d.enquirySubmitted=!0,b()})}),c.render("contact")};var keystone=require("keystone");exports=module.exports=function(a,b){var c=new keystone.View(a,b),d=b.locals;d.section="gallery",c.query("galleries",keystone.list("Gallery").model.find().sort("sortOrder")),c.render("gallery")};var keystone=require("keystone");exports=module.exports=function(a,b){var c=new keystone.View(a,b),d=b.locals;d.section="home",c.render("index")};var keystone=require("keystone");exports=module.exports=function(a,b){var c=new keystone.View(a,b),d=b.locals;d.section="blog",d.filters={post:a.params.post},d.data={posts:[]},c.on("init",function(a){var b=keystone.list("Post").model.findOne({state:"published",slug:d.filters.post}).populate("author categories");b.exec(function(b,c){d.data.post=c,a(b)})}),c.on("init",function(a){var b=keystone.list("Post").model.find().where("state","published").sort("-publishedDate").populate("author").limit("4");b.exec(function(b,c){console.log("results",c),d.data.posts=c,a(b)})}),c.render("post")};